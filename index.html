<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOTORI STEEL - Quality Roofing & Steel Products</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .page { display: none; }
        .page.active { display: block; }

        /* 3D Button Styles */
        .btn-3d {
            position: relative;
            transform: translateZ(0);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .btn-3d:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .btn-3d:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }

        /* Hero Slider */
        .hero-slider {
            position: relative;
            height: 600px;
            overflow: hidden;
            border-radius: 20px;
        }
        .slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
            background-size: cover;
            background-position: center;
        }
        .slide.active {
            opacity: 1;
        }
        .slide::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
        }

        /* Floating Animation */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .float { animation: float 3s ease-in-out infinite; }

        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Card Hover Effect */
        .card-3d {
            transition: all 0.3s ease;
            position: relative;
        }
        .card-3d:hover {
            transform: translateY(-15px) rotateX(5deg);
            box-shadow: 0 30px 60px rgba(102, 126, 234, 0.4);
        }

        /* Animated Gradient Background */
        .animated-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Product Cards Slider */
        .products-slider {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 20px 0;
        }
        .products-slider::-webkit-scrollbar {
            height: 8px;
        }
        .products-slider::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .products-slider::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .product-card {
            flex: 0 0 280px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .product-card:hover {
            transform: scale(1.08) rotateY(5deg);
            box-shadow: 0 20px 50px rgba(102, 126, 234, 0.3);
        }

        /* Navbar Styling */
        nav {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        /* Stats Counter */
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        /* Scroll Animation */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* New Scroll-Reveal Animation */
        .scroll-reveal {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .scroll-reveal.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Catalog Slider Styles */
        #imageCatalog { background: #111; }
        .catalog-slider {
            position: relative;
            width: 100%;
            height: calc(100vh - 150px); /* Adjust height based on header/footer */
            overflow: hidden;
            border-radius: 15px;
            background: #000;
        }
        .catalog-slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .catalog-slide.active { opacity: 1; }
        .catalog-slide img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 10px; }
    </style>
    <style>
        /* Custom Admin Panel Styles */
        .admin-modal-content {
            background-color: #f7f8fc;
        }
        .admin-tab-btn {
            position: relative;
            padding: 10px 20px;
            font-weight: 600;
            color: #4a5568;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .admin-tab-btn.active {
            background-color: white;
            color: #4c51bf;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .admin-tab-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #e53e3e;
            color: white;
            border-radius: 9999px;
            width: 22px;
            height: 22px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .admin-section-card {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .admin-input {
            border: 2px solid #e2e8f0;
            transition: border-color 0.2s ease;
        }
        .admin-input:focus { border-color: #667eea; }

        /* Gallery Page Styles */
        .project-card {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.4s ease, box-shadow 0.4s ease;
        }
        .project-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
        }
        .project-card img {
            transition: transform 0.4s ease;
        }
        .project-card:hover img {
            transform: scale(1.1);
        }
        .project-card-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 60%);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 24px;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- Navigation -->
    <nav class="sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="text-3xl font-extrabold tracking-tight text-red-600">
                    <span>GOTORI STEEL</span>
                </div>
                <div class="hidden md:flex items-center space-x-4">
                    <button onclick="showPage('quotation')" class="nav-button nav-button-primary"><i class="bi bi-calculator-fill"></i>Get Quote</button>
                    <button onclick="showPage('dailyReport')" class="nav-button text-gray-700"><i class="bi bi-file-earmark-text"></i>Daily Report</button>
                    <button onclick="openRateEditor()" class="text-red-600 hover:text-red-800 font-bold transition p-2 rounded-full hover:bg-red-100">‚öôÔ∏è</button>
                </div>
                <button class="md:hidden" onclick="toggleMobileMenu()">
                    <i class="bi bi-list text-3xl text-gray-700"></i>
                </button>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden md:hidden bg-white border-t border-gray-200 p-4">
            <div class="flex flex-col space-y-4">
                <button onclick="showPage('quotation')" class="text-gray-700 hover:text-blue-600 font-semibold">Get Quote</button>
                <button onclick="showPage('dailyReport')" class="text-gray-700 hover:text-blue-600 font-semibold">Daily Report</button>
                <button onclick="openRateEditor()" class="text-red-600 hover:text-red-800 font-bold">‚öôÔ∏è Edit Rates</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Wrapper -->
    <main class="flex-grow">

    <!-- ...existing quotation, contact pages... -->
    <!-- Quotation Page -->
    <div id="quotation" class="page active">
        <div class="max-w-7xl mx-auto px-4 py-12">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-4xl font-bold text-white">Get a Quote</h2>
                <button onclick="clearQuoteForm()" class="btn-3d bg-red-500 text-white px-6 py-2 rounded-lg font-bold">
                    ‚ú® Clear All
                </button>
            </div>
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <!-- removed inline onsubmit to avoid double submit -->
                <form id="quotationForm">
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="relative">
                            <label class="block mb-2 font-semibold text-gray-800">Customer Name</label>
                            <input type="text" required class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" name="customerName" onkeyup="suggestCustomers(event)" autocomplete="off">
                            <div id="customerSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 hidden shadow-lg max-h-60 overflow-y-auto">
                            </div>
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold text-gray-800">Contact Number</label>
                            <input type="tel" required class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" name="phone">
                        </div>
                        <!-- Email input removed as requested -->
                        <div>
                            <label class="block mb-2 font-semibold text-gray-800">Product Type</label>
                            <select class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" name="productType" onchange="updateProductFields()">
                                <option value="roofing">Roofing Sheets</option>
                                <option value="pipes">MS Pipes</option>
                                <option value="screws">Screws</option>
                                <option value="polycarbonate">Polycarbonate Sheets</option>
                            </select>
                        </div>
                    </div>

                    <div id="productFields" class="mb-6"></div>

                    <div class="flex flex-wrap gap-4">
                        <button type="button" onclick="addItem()" class="btn-3d bg-gradient-to-r from-indigo-600 to-indigo-700 text-white px-6 py-3 rounded-lg font-bold">
                            ‚ûï Add Item to Quote
                        </button>
                        <button type="submit" class="btn-3d bg-gradient-to-r from-blue-900 to-blue-800 text-white px-6 py-3 rounded-lg font-bold">
                            üßÆ Calculate Quote
                        </button>
                    </div>

                    <div id="itemsList" class="mt-6"></div>
                </form>

                <div id="quoteResult" class="mt-8 hidden"></div>
            </div>
        </div>
    </div>

    <!-- Daily Report Page -->
    <div id="dailyReport" class="page">
        <div class="max-w-4xl mx-auto px-4 py-12">
            <h2 class="text-4xl font-bold text-white mb-8">Daily Report</h2>
            <div class="bg-white p-8 rounded-xl shadow-lg">
                
                <!-- Tabs for Entry and Expenditure -->
                <div class="flex gap-4 mb-8 bg-gray-200 p-2 rounded-lg">
                    <button id="entryTabBtn" onclick="showDailyReportTab('entry')" class="flex-1 py-3 px-4 font-bold text-gray-700 bg-white rounded-lg shadow transition hover:bg-gray-50 active">
                        üìù Add Entry (Sales)
                    </button>
                    <button id="expenditureTabBtn" onclick="showDailyReportTab('expenditure')" class="flex-1 py-3 px-4 font-bold text-gray-700 hover:bg-white rounded-lg transition">
                        üí∏ Add Expenditure
                    </button>
                </div>

                <!-- Entry (Sales) Tab -->
                <div id="entryContent">
                <form id="dailyReportForm">
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="relative">
                            <label class="block mb-2 font-semibold text-gray-800">Customer Name</label>
                            <input type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" name="reportCustomerName" placeholder="e.g., John Doe or 'Cash Sale'" onkeyup="suggestDailyReportCustomers(event)" autocomplete="off">
                            <div id="dailyReportCustomerSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 hidden shadow-lg max-h-60 overflow-y-auto"></div>
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold text-gray-800">Contact Number</label>
                            <input type="tel" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" name="reportPhone" placeholder="(Optional)">
                        </div>
                    </div>
                    <div class="border-t border-gray-200 pt-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Add Items</h3>
                        
                        <!-- Dynamic Product Selection -->
                        <div class="grid md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label class="block mb-2 font-semibold text-gray-800">Product Type</label>
                                <select class="w-full p-3 border-2 border-gray-300 rounded-lg" name="reportProductType" onchange="updateDailyReportProductFields()">
                                    <option value="roofing">Roofing Sheets</option>
                                    <option value="pipes">MS Pipes</option>
                                    <option value="screws">Screws</option>
                                    <option value="polycarbonate">Polycarbonate Sheets</option>
                                </select>
                            </div>
                        </div>
                        <div id="dailyReportProductFields" class="mb-4"></div>

                        <!-- Manual Weight and Rate -->
                        <div class="grid md:grid-cols-3 gap-4 mb-4 items-end bg-blue-50 p-4 rounded-lg">
                            <div id="reportWeightContainer">
                                <label class="block mb-1 font-semibold text-sm text-blue-800">Total Weight (kg)</label>
                                <input type="number" id="reportItemWeight" placeholder="Enter total weight" class="w-full p-3 border-2 border-blue-200 rounded-lg">
                            </div>
                            <div>
                                <label id="reportRateLabel" class="block mb-1 font-semibold text-sm text-blue-800">Rate (per kg/pc)</label>
                                <input type="number" id="reportItemRate" placeholder="Enter rate" class="w-full p-3 border-2 border-blue-200 rounded-lg">
                            </div>
                            <button type="button" onclick="addDailyReportItem()" class="btn-3d bg-indigo-500 text-white h-12 rounded-lg font-bold">
                                ‚ûï Add Item
                            </button>
                        </div>
                    </div>
                </form>

                <div id="dailyReportItemsList" class="mt-6">
                    <!-- Items will be added here -->
                </div>

                <div class="text-center mt-8">
                    <button id="saveDailyReportBtn" type="button" onclick="saveDailyReport()" class="btn-3d bg-green-600 text-white px-10 py-4 rounded-lg font-bold text-lg">
                        üíæ Save Entry
                    </button>
                </div>
                </div>

                <!-- Expenditure Tab -->
                <div id="expenditureContent" class="hidden">
                <div class="bg-red-50 p-6 rounded-lg">
                    <h4 class="text-lg font-bold text-red-700 mb-3">Add Daily Expenditure</h4>
                    <form id="dailyExitForm" class="grid md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label class="block mb-1 font-semibold text-sm text-red-700">Description</label>
                            <input name="exitDescription" type="text" placeholder="e.g., Transport / Lunch / Fuel" class="w-full p-3 border-2 border-red-200 rounded-lg admin-input">
                        </div>
                        <div>
                            <label class="block mb-1 font-semibold text-sm text-red-700">Amount (‚Çπ)</label>
                            <input name="exitAmount" type="number" step="0.01" placeholder="0.00" class="w-full p-3 border-2 border-red-200 rounded-lg admin-input">
                        </div>
                        <div>
                            <button type="button" onclick="saveDailyExit()" class="btn-3d bg-red-600 text-white px-4 py-3 rounded-lg font-bold w-full">‚ûï Add Expense</button>
                        </div>
                    </form>

                    <div id="dailyExitsListPage" class="mt-4">
                        <!-- Today's expenditures will render here -->
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Catalog Page -->
    <div id="imageCatalog" class="page fixed inset-0 bg-gray-900 z-50">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-8">
                <h2 id="catalogTitle" class="text-4xl font-bold text-white">Product Catalog</h2>
                <button onclick="closeImageCatalog()" class="btn-3d bg-red-500 text-white px-6 py-2 rounded-lg font-bold">‚Üê Back</button>
            </div>
            <div class="catalog-slider">
                <div id="catalogSlidesContainer">
                    <!-- Slides will be injected here -->
                </div>
                <!-- Slider Controls -->
                <button onclick="prevCatalogSlide()" class="absolute left-4 top-1/2 -translate-y-1/2 z-10 bg-white/80 hover:bg-white p-3 rounded-full transition">
                    <i class="bi bi-chevron-left text-2xl text-gray-800"></i>
                </button>
                <button onclick="nextCatalogSlide()" class="absolute right-4 top-1/2 -translate-y-1/2 z-10 bg-white/80 hover:bg-white p-3 rounded-full transition">
                    <i class="bi bi-chevron-right text-2xl text-gray-800"></i>
                </button>
                <!-- Slider Indicators -->
                <div id="catalogDotsContainer" class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-2 z-10">
                    <!-- Dots will be injected here -->
                </div>
            </div>
        </div>
    </div>
    </main>

    <!-- Admin Modal -->
    <div id="rateEditorModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="admin-modal-content p-6 rounded-2xl w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-3xl font-bold text-gray-800">Admin Panel</h3>
                <button onclick="closeRateEditor()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <div class="flex gap-2 mb-6 bg-gray-200 p-2 rounded-lg">
                <button id="ratesTabBtn" onclick="showRateEditorTab('rates')" class="admin-tab-btn flex-1">
                    üí∞ Edit Rates
                </button>
                <button id="quotesTabBtn" onclick="showRateEditorTab('quotes')" class="admin-tab-btn flex-1">
                    üìã Pending Quotes <span id="pendingQuotesCount" class="badge">0</span>
                </button>
                <button id="ordersTabBtn" onclick="showRateEditorTab('orders')" class="admin-tab-btn flex-1">
                    ‚úîÔ∏è Confirmed Orders <span id="confirmedOrdersCount" class="badge">0</span>
                </button>
                <button id="customersTabBtn" onclick="showRateEditorTab('customers')" class="admin-tab-btn flex-1">
                    üë• Customers
                </button>
                <button id="dailyReportsTabBtn" onclick="showRateEditorTab('dailyReports')" class="admin-tab-btn flex-1">
                    üìà Daily Reports
                </button>
            </div>

            <div id="ratesContent" class="hidden overflow-y-auto flex-1">
                <form id="rateEditorForm" class="space-y-4">
                    <div id="rateEditorFields" class="space-y-3"></div>
                    <div class="flex justify-end gap-4 mt-6 sticky bottom-0 bg-gray-100 py-4">
                        <button type="button" onclick="closeRateEditor()" class="px-6 py-3 bg-gray-300 rounded-lg font-bold text-gray-700">Cancel</button>
                        <button type="submit" class="btn-3d px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-bold">‚úÖ Save All Rates</button>
                    </div>
                </form>
            </div>

            <div id="quotesContent" class="hidden overflow-y-auto flex-1">
                <div class="flex justify-end mb-4">
                    <button onclick="clearAllSavedQuotes()" class="btn-3d px-4 py-2 bg-red-600 text-white rounded-lg font-bold text-sm">
                        üóëÔ∏è Clear All Quotes
                    </button>
                </div>
                <div id="savedQuotesList" class="space-y-4"></div>
            </div>

            <div id="ordersContent" class="hidden overflow-y-auto flex-1">
                <div class="flex justify-end mb-4">
                    <button onclick="clearAllConfirmedOrders()" class="btn-3d px-4 py-2 bg-red-600 text-white rounded-lg font-bold text-sm">
                        <i class="bi bi-trash-fill"></i> Clear All Orders
                    </button>
                </div>
                <div id="confirmedOrdersList" class="space-y-3"></div>
            </div>

            <div id="customersContent" class="hidden overflow-y-auto flex-1">
                <!-- Customer list and history will be rendered here -->
            </div>

            <div id="dailyReportsContent" class="hidden overflow-y-auto flex-1">
                <div class="flex justify-end items-center gap-4 mb-4">
                    <input type="date" id="reportPrintDate" class="admin-input p-2 rounded-lg">
                    <button onclick="printDailySummary()" class="btn-3d px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm flex items-center gap-2">
                        <i class="bi bi-printer-fill"></i> Print Report
                    </button>
                    <button onclick="clearAllDailyReports()" class="btn-3d px-4 py-2 bg-red-600 text-white rounded-lg font-bold text-sm flex items-center gap-2">
                        <i class="bi bi-trash-fill"></i> Clear All Reports
                    </button>
                </div>
                <div id="dailyReportsList" class="space-y-4"></div>
                <!-- daily exits list element is optional; renderAdminLists will skip if missing -->
                <div id="dailyExitsList" class="space-y-4 mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Sticky Footer -->
    <footer class="bg-gray-900 text-white py-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <div class="mb-4">
                <h3 class="text-2xl font-bold">GOTORI STEEL</h3>
                <p class="text-gray-400">Your trusted partner in quality steel and roofing.</p>
            </div>
            <div class="flex justify-center space-x-6 mb-6">
                <a href="https://wa.me/9019465266" target="_blank" class="text-gray-400 hover:text-white transition text-2xl"><i class="bi bi-whatsapp"></i></a>
                <a href="#" class="text-gray-400 hover:text-white transition text-2xl"><i class="bi bi-facebook"></i></a>
                <a href="#" class="text-gray-400 hover:text-white transition text-2xl"><i class="bi bi-instagram"></i></a>
                <a href="mailto:hashirgotori0@gmail.com" class="text-gray-400 hover:text-white transition text-2xl"><i class="bi bi-envelope-fill"></i></a>
            </div>
            <div class="border-t border-gray-700 pt-6">
                <p class="text-gray-500">&copy; 2024 GOTORI STEEL. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

<script>
/* Improved handlers: attach submit listener on DOMContentLoaded, safer modal show/hide,
   defensive null-checks so mobile/older browsers don't break. */

let currentCatalogSlide = 0;
let catalogSlideTimer = null;

const initialProducts = {
    bendingRate: 100,
    roofing: { 
        name: 'Roofing Sheets',
        brands: {
            'Essar': { rate: 80, colors: ['BLUE'], weightPerFoot: 1.1, images: { 'BLUE': 'https://www.jswcoatedsteel.in/jsw-colouron-plus/profile/profile3/2.jpg' } },
            'AMNS': { rate: 86, colors: ['BLUE', 'TURKISH GREEN', 'ORANGE', 'EGG WHITE'], weightPerFoot: 1.35, images: { 'BLUE': 'https://www.jswcoatedsteel.in/jsw-colouron-plus/profile/profile3/2.jpg', 'TURKISH GREEN': 'https://www.jswcoatedsteel.in/jsw-colouron-plus/profile/profile3/6.jpg', 'ORANGE': 'https://www.jswcoatedsteel.in/jsw-colouron-plus/profile/profile3/11.jpg', 'EGG WHITE': 'https://www.jswcoatedsteel.in/jsw-colouron-plus/profile/profile1/1.jpg' } },
            'JSW INDRADHANUSH': { rate: 88, colors: ['BLUE', 'TURKISH GREEN', 'ORANGE', 'EGG WHITE'], weightPerFoot: 1.36, images: { 'BLUE': 'https://www.jswcoatedsteel.in/jsw-colouron-plus/profile/profile3/2.jpg', 'TURKISH GREEN': 'https://www.jswcoatedsteel.in/jsw-colouron-plus/profile/profile3/6.jpg', 'ORANGE': 'https://www.jswcoatedsteel.in/jsw-colouron-plus/profile/profile3/11.jpg', 'EGG WHITE': 'https://www.jswcoatedsteel.in/jsw-colouron-plus/profile/profile1/1.jpg' } },
            'JSW Silveron+': { rate: 104, colors: ['Premium Silver'], weightPerFoot: 1.39, images: { 'Premium Silver': 'https://www.jswcoatedsteel.in/silveron/img/9.jpg' } },
            'JSW Colouron+': { rate: 125, colors: ['ORANGE', 'BLUE', 'WHITE'], weightPerFoot: 1.36, images: { 'ORANGE': 'https://www.jswcoatedsteel.in/silveron/img/9.jpg' } }
        },
        images: [
            'https://www.kavyaroofing.com/wp-content/uploads/2024/11/2.-Colored-UPVC-roofing-sheets-suppliers.jpg',
            'https://www.jswcoatedsteel.in/silveron/img/2.jpg',
            'https://5.imimg.com/data5/SELLER/Default/2025/7/528159658/AO/KH/MW/55761741/roofing-sheet-1-500x500.jpg'
        ]
    },
    pipes: { 
        name: 'MS Pipes',
        sizes: { '1 inch': { weights: [8, 9], rate: 58 }, '1.5 inch': { weights: [11, 13], rate: 56 }, '2 inch': { weights: [14, 16.5, 20], rate: 56 }, '3 inch': { weight: 32, rate: 58 }, '4 inch': { weight: 46.5, rate: 61 } },
        images: [
            'https://t4.ftcdn.net/jpg/03/05/01/69/360_F_305016946_SjDUc8U1frDtFuU9Y0F6OPASVvaoAJxS.jpg',
            'https://as1.ftcdn.net/v2/jpg/02/33/27/93/1000_F_233279326_k32g3p22n9s9x8pe72cO8KjA4E3v1u54.jpg',
            'https://www.jswcoatedsteel.in/silveron/img/10_revised.jpg'
        ]
    },
    screws: { 
        name: 'Screws & Hardware',
        rate: 2,
        images: [
            'https://media.istockphoto.com/id/183735818/photo/screws.jpg?s=612x612&w=0&k=20&c=LzEDbFE2bB3v_lAN2p7T2iS2L4uQyAJi3i3o5a3VKrY=',
            'https://www.bigbasket.com/media/uploads/p/l/40289136_1-visko-tools-screw-driver-kit-with-tester-set-of-8-pcs.jpg'
        ]
    },
    polycarbonate: {
        name: 'Polycarbonate Sheets',
        types: [
            { width: 3, thickness: 1.5, rate: 25 },
            { width: 4, thickness: 1, rate: 18 },
            { width: 4, thickness: 1.5, rate: 25 },
            { width: 4, thickness: 2, rate: 35 },
            { width: 4, thickness: 1.8, rate: 80 },
            { width: 4, thickness: 3, rate: 95 },
            { width: 5, thickness: 1, rate: 18 },
            { width: 5, thickness: 1.5, rate: 25 },
            { width: 5, thickness: 2, rate: 35 },
            { width: 5, thickness: 1.8, rate: 80 },
            { width: 5, thickness: 3, rate: 95 }
        ],
        images: ['https://5.imimg.com/data5/ANDROID/Default/2023/1/SE/UY/VT/15739955/product-jpeg-500x500.jpg', 'https://www.eplastics.com/images/products/polycarbonate/clear-polycarbonate-sheets-01.jpg']
    }
};
let products = {}; // This will be populated from Google Sheets
const quoteItems = [];

const galleryProjects = [
    {
        title: 'MS PIPES',
        image: 'https://www.metalsupplies.com/wp-content/uploads/2016/11/mild-steel-hollow-section.jpg',
        description: 'This factory shed uses premium Essar roofing for cost-effective coverage and 3-inch pipes for structural integrity.',
        productsUsed: ['Essar', '3 inch MS Pipes', 'Screws']
    },
    {
        title: 'ROOFING SHEETS',
        image: 'https://images.jdmagicbox.com/quickquotes/images_main/color-coated-tata-metal-galvanized-roofing-sheet-2217334560-wvrzrufn.jpg',
        description: 'This factory shed uses premium Essar roofing for cost-effective coverage and 3-inch pipes for structural integrity.',
        productsUsed: ['Essar', '3 inch MS Pipes', 'Screws']
    },
    {
        title: 'POLYCARBONATE SHEETS',
        image: 'https://5.imimg.com/data5/SELLER/Default/2024/11/463771618/KM/QL/BL/181055037/tilara-polycarbonate-multiwall-sheets.jpg',
        description: 'This factory shed uses premium Essar roofing for cost-effective coverage and 3-inch pipes for structural integrity.',
        productsUsed: ['Essar', '3 inch MS Pipes', 'Screws']
    },
    {
        title: 'RAINWATER GUTTERS',
        image: 'https://aquarain.in/blog/wp-content/uploads/2025/07/A-List-of-FAQs-About-Rainwater-Gutters.jpg',
        description: 'Durable and weather-proof roofing solution for a large agricultural storage barn, ensuring protection for assets.',
        productsUsed: ['JSW INDRADHANUSH', '2 inch MS Pipes']
    },
    {
        title: 'TURBO VENTILATORS',
        image: 'https://5.imimg.com/data5/SELLER/Default/2025/1/478312369/SF/DY/ET/237764771/air-ventilator-system.jpg',
        description: 'A modern commercial complex using sleek Polycarbonate sheets for a stylish and contemporary exterior look.',
        productsUsed: ['Polycarbonate Sheets', 'Screws']
    },
    {
        title: 'RESIDENTIAL BUILDING',
        image: 'https://5.imimg.com/data5/SELLER/Default/2025/10/553587487/EU/YY/BM/246633775/prefab-ms-pre-engineered-building-structure-500x500.png',
        description: 'A beautiful family home featuring a premium JSW Colouron+ roof that combines aesthetics with high performance.',
        productsUsed: ['JSW Colouron+', '1.5 inch MS Pipes']
    }
];
const QUOTES_KEY = 'gotoristeel_quotes';
const CUSTOMERS_KEY = 'gotoristeel_customers';
const DAILY_REPORTS_KEY = 'gotoristeel_daily_reports';
const DAILY_EXITS_KEY = 'gotoristeel_daily_exits';
const dailyReportItems = [];

function loadLocalProducts() {
    products = initialProducts;
    console.log('‚úÖ Products loaded from local data.');
}

function loadSavedQuotes() { try { return JSON.parse(localStorage.getItem(QUOTES_KEY) || '[]'); } catch (e) { return []; } }
function saveQuotesToStorage(quotes) { try { localStorage.setItem(QUOTES_KEY, JSON.stringify(quotes)); } catch (e) {} }
function loadCustomers() { try { return JSON.parse(localStorage.getItem(CUSTOMERS_KEY) || '[]'); } catch (e) { return []; } }
function saveCustomers(customers) { try { localStorage.setItem(CUSTOMERS_KEY, JSON.stringify(customers)); } catch (e) {} }
function addSavedQuote(quote) { const quotes = loadSavedQuotes(); quotes.unshift(quote); saveQuotesToStorage(quotes); updateQuoteCounts(); }
function updateQuoteCounts() {
    if (!document.getElementById('pendingQuotesCount')) return; // Exit if admin panel isn't open
    const allQuotes = loadSavedQuotes();
    document.getElementById('pendingQuotesCount').textContent = allQuotes.filter(q => q.status === 'quoted').length;
    document.getElementById('confirmedOrdersCount').textContent = allQuotes.filter(q => q.status === 'confirmed' || q.status === 'completed').length;
}

function displayPage(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    const target = document.getElementById(pageId);

    if (pageId !== 'imageCatalog') stopAutoCatalogSlide();

    if (target) {
        target.classList.add('active');
    } else {
        // Fallback to quotation if pageId is invalid
        document.getElementById('quotation')?.classList.add('active');
    }

    if (window.innerWidth < 768) {
        document.getElementById('mobileMenu')?.classList.add('hidden');
    }
    window.scrollTo(0, 0); // Scroll to top on page change
}

function showPage(pageId) {
    const currentState = history.state;
    if (!currentState || currentState.page !== pageId) {
        history.pushState({ page: pageId }, '', `#${pageId}`);
    }
    displayPage(pageId);
}

function toggleMobileMenu() {
    document.getElementById('mobileMenu')?.classList.toggle('hidden');
}

/* Quotation helpers */
function updateProductFields() {
    const productType = document.querySelector('[name="productType"]')?.value || 'roofing';
    const fieldsContainer = document.getElementById('productFields');
    if (!fieldsContainer) return;
    let html = '';

    if (productType === 'roofing') {
        html = `<div class="grid md:grid-cols-2 lg:grid-cols-5 gap-4 items-end"><div><label class="block mb-2 font-semibold">Brand</label><select name="brand" class="w-full p-3 border-2 rounded-lg" onchange="updateColorOptions()">${Object.keys(products.roofing.brands).map(b => `<option value="${b}">${b}</option>`).join('')}</select></div><div><label class="block mb-2 font-semibold">Colour</label><select name="color" class="w-full p-3 border-2 rounded-lg"></select></div><div><label class="block mb-2 font-semibold">Length (feet)</label><input type="number" name="length" class="w-full p-3 border-2 rounded-lg" min="1" value="13"></div><div><label class="block mb-2 font-semibold">Qty</label><input type="number" name="quantity" class="w-full p-3 border-2 rounded-lg" min="1" value="1"></div><div class="flex items-center gap-2 pb-3"><input type="checkbox" id="addBending" name="addBending" class="h-5 w-5 rounded"><label for="addBending" class="font-semibold text-gray-700">Add Bending <span class="text-sm font-normal">(+‚Çπ${products.bendingRate}/sheet)</span></label></div></div>`;
    } else if (productType === 'pipes') {
        html = `<div class="grid md:grid-cols-3 gap-4"><div><label class="block mb-2 font-semibold">Size</label><select name="size" class="w-full p-3 border-2 rounded-lg" onchange="updateWeightOptions()">${Object.keys(products.pipes.sizes).map(s => `<option value="${s}">${s}</option>`).join('')}</select></div><div><label class="block mb-2 font-semibold">Weight</label><select name="weight" class="w-full p-3 border-2 rounded-lg"></select></div><div><label class="block mb-2 font-semibold">Qty</label><input type="number" name="quantity" class="w-full p-3 border-2 rounded-lg" min="1" value="1"></div></div>`;
    } else if (productType === 'polycarbonate') {
        const options = products.polycarbonate.types.map((p, i) => `<option value="${i}">${p.width}' Feet Width / ${p.thickness}mm Thickness</option>`).join('');
        html = `<div class="grid md:grid-cols-3 gap-4"><div><label class="block mb-2 font-semibold">Sheet Type</label><select name="polyType" class="w-full p-3 border-2 rounded-lg">${options}</select></div><div><label class="block mb-2 font-semibold">Length (feet)</label><input type="number" name="length" class="w-full p-3 border-2 rounded-lg" min="1" value="10"></div><div><label class="block mb-2 font-semibold">Qty</label><input type="number" name="quantity" class="w-full p-3 border-2 rounded-lg" min="1" value="1"></div></div>`;
    } else {
        html = `<div><label class="block mb-2 font-semibold">Qty</label><input type="number" name="quantity" class="w-full p-3 border-2 rounded-lg" min="1" value="10"></div>`;
    }
    fieldsContainer.innerHTML = html;
    if (productType === 'roofing') setTimeout(updateColorOptions, 0);
    if (productType === 'pipes') setTimeout(updateWeightOptions, 0);
}

function updateWeightOptions() {
    const size = document.querySelector('[name="size"]')?.value;
    const sel = document.querySelector('[name="weight"]');
    if (!size || !sel) return;
    const d = products.pipes.sizes[size] || {};
    let arr = Array.isArray(d.weights) ? d.weights : [d.weight];
    sel.innerHTML = arr.map(w => `<option value="${w}">${w} kg</option>`).join('');
}

function updateColorOptions() {
    const brand = document.querySelector('[name="brand"]')?.value;
    const colorSelect = document.querySelector('[name="color"]');
    if (!brand || !colorSelect) return;
    const brandData = products.roofing.brands[brand];
    const colors = brandData?.colors || [];
    colorSelect.innerHTML = colors.map(c => `<option value="${c}">${c}</option>`).join('');
}

function addItem() {
    const form = document.getElementById('quotationForm');
    if (!form) return alert('Quotation form not found.');
    const fd = new FormData(form);
    const type = fd.get('productType');
    if (!type) return alert('Select product type');
    let item = null;
    if (type === 'roofing') {
        const brand = fd.get('brand'), color = fd.get('color'), length = +fd.get('length'), qty = +fd.get('quantity');
        const addBending = form.querySelector('[name="addBending"]')?.checked;
        const brandData = products.roofing.brands[brand] || {};
        const rate = brandData.rate || 0;
        const wt = length * (brandData.weightPerFoot || 0);
        const itemTotal = wt * rate * qty;
        const details = `${brand} ‚Ä¢ ${color} ‚Ä¢ ${length} ft`;

        // Create and push the primary roofing sheet item
        const roofingItem = { type: 'Roofing', details: details, unitRate: rate, quantity: qty, weight: wt * qty, total: itemTotal };
        quoteItems.push(roofingItem);

        // If bending is requested, create a completely separate line item for it
        if (addBending) {
            const bendingRate = products.bendingRate || 0;
            const bendingItem = { type: '‚Ü™Ô∏è Bending Charge', details: `For ${qty} roofing sheets`, unitRate: bendingRate, quantity: qty, weight: 0, total: bendingRate * qty };
            quoteItems.push(bendingItem);
        }
    } else if (type === 'pipes') {
        const size = fd.get('size'), weight = +fd.get('weight'), qty = +fd.get('quantity');
        const rate = (products.pipes.sizes[size]?.rate) || 0;
        item = { type: 'MS Pipe', details: `${size} ‚Ä¢ ${weight} kg`, unitRate: rate, quantity: qty, weight: weight * qty, total: weight * rate * qty };
    } else if (type === 'polycarbonate') {
        const typeIndex = +fd.get('polyType');
        const polyType = products.polycarbonate.types[typeIndex];
        const length = +fd.get('length');
        item = { type: 'Polycarbonate', details: `${polyType.width}' x ${length}' (${polyType.thickness}mm)`, unitRate: polyType.rate, quantity: qty, weight: 0, total: sqft * polyType.rate * qty };
    } else {
        const qty = +fd.get('quantity'), rate = products.screws.rate;
        item = { type: 'Screws', details: 'Per piece', unitRate: rate, quantity: qty, weight: 0, total: qty * rate };
    }
    if (item) quoteItems.push(item);
    renderItems();
    updateProductFields();
}

function renderItems() {
    const el = document.getElementById('itemsList');
    if (!el) return;
    if (!quoteItems.length) { el.innerHTML = '<p class="text-gray-600">No items added.</p>'; return; }
    el.innerHTML = `<div class="overflow-x-auto bg-gray-100 p-4 rounded-lg"><table class="w-full"><thead class="bg-gradient-to-r from-blue-900 to-blue-700 text-white"><tr><th class="px-4 py-2">#</th><th class="px-4 py-2">Type</th><th class="px-4 py-2">Details</th><th class="px-4 py-2">Qty</th><th class="px-4 py-2">Weight (kg)</th><th class="px-4 py-2">Rate</th><th class="px-4 py-2">Total</th><th class="px-4 py-2">Action</th></tr></thead><tbody>${quoteItems.map((it, i) =>
        `<tr class="border-b hover:bg-gray-200"><td class="px-4 py-2">${i + 1}</td><td class="px-4 py-2">${it.type}</td><td class="px-4 py-2">${it.details}</td><td class="px-4 py-2">${it.quantity}</td><td class="px-4 py-2">${it.weight > 0 ? Number(it.weight).toFixed(2) : 'N/A'}</td><td class="px-4 py-2">‚Çπ${Number(it.unitRate).toFixed(2)}</td><td class="px-4 py-2 font-bold">‚Çπ${Number(it.total).toFixed(2)}</td><td class="px-4 py-2"><button onclick="removeItem(${i})" class="text-red-600 font-bold hover:text-red-800">Remove</button></td></tr>`
    ).join('')}</tbody></table></div>`;
}

function removeItem(i) { quoteItems.splice(i, 1); renderItems(); }

function clearQuoteForm() {
    if (quoteItems.length === 0 && !document.querySelector('[name="customerName"]').value) return; // Do nothing if already empty

    if (confirm('Are you sure you want to clear the current quote? All items and customer details will be removed.')) {
        quoteItems.length = 0; // Clear the items array
        renderItems(); // Re-render the empty items list

        const form = document.getElementById('quotationForm');
        if (form) form.reset(); // Reset all form fields
        document.getElementById('quoteResult')?.classList.add('hidden'); // Hide the summary
        updateProductFields(); // Reset product-specific fields
    }
}

function calculateQuote(e) {
    if (e && typeof e.preventDefault === 'function') e.preventDefault();
    if (quoteItems.length === 0) return alert('Please add at least one item to the quote before calculating.');
    
    const form = document.getElementById('quotationForm');
    const fd = form ? new FormData(form) : new FormData();
    const customer = fd.get('customerName') || '', phone = fd.get('phone') || '';

    if (!customer || !phone) {
        return alert('Please enter both Customer Name and Contact Number before calculating the quote.');
    }

    const total = quoteItems.reduce((s, it) => s + (Number(it.total) || 0), 0);
    const resultEl = document.getElementById('quoteResult');
    if (resultEl) {
        const quoteId = 'Q' + Date.now();
        // Save the quote to localStorage *before* rendering the confirm button
        const quoteObject = { id: quoteId, timestamp: new Date().toISOString(), customerName: customer, phone, items: JSON.parse(JSON.stringify(quoteItems)), total, status: 'quoted', advancePaid: 0 };
        addSavedQuote(quoteObject);

        resultEl.classList.remove('hidden');
        const itemsSummaryHtml = quoteItems.map(it => {
            let summary = `<strong>${it.type}</strong> ‚Äî ${it.details} ‚Äî Qty:${it.quantity} ‚Äî ‚Çπ${Number(it.total).toFixed(2)}`;
            return `<div class="mb-2">${summary}</div>`;
        }).join('');
        resultEl.innerHTML = `<div class="mt-4 bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg border-2 border-green-500">
            <h4 class="text-2xl font-bold text-gray-800 mb-4">‚úÖ Quotation Summary</h4>
            <div class="text-gray-700 mb-4"><strong>üë§ Customer:</strong> ${customer} ‚Ä¢ ${phone}</div>
            ${itemsSummaryHtml}
            <div class="mt-4 text-2xl font-bold text-green-600">üí∞ Grand Total: ‚Çπ${Number(total).toFixed(2)}</div>
            <div id="quoteActions" class="flex flex-wrap gap-4 mt-6">
                <button onclick="printQuote()" class="btn-3d bg-blue-900 text-white px-6 py-2 rounded-lg font-bold">üñ®Ô∏è Print</button>
                <button onclick="confirmOrder('${quoteId}')" class="btn-3d bg-green-600 text-white px-6 py-2 rounded-lg font-bold">‚úîÔ∏è Confirm Order</button>
            </div>
        </div>`;
    }
}

function confirmOrder(quoteId) {
    const advanceAmountStr = prompt("Enter advance amount paid by customer (leave blank or enter 0 if none):", "0");
    if (advanceAmountStr === null) return; // User clicked cancel
    const advanceAmount = parseFloat(advanceAmountStr) || 0;
    let quotes = loadSavedQuotes();
    const quoteIndex = quotes.findIndex(q => q.id === quoteId);
    if (quoteIndex !== -1) {
        quotes[quoteIndex].status = 'confirmed';
        quotes[quoteIndex].advancePaid = advanceAmount;
        saveQuotesToStorage(quotes);

        // Add or update customer in the database
        const customerName = quotes[quoteIndex].customerName;
        const customerPhone = quotes[quoteIndex].phone;
        let customers = loadCustomers();
        if (!customers.some(c => c.phone === customerPhone)) {
            customers.unshift({ name: customerName, phone: customerPhone, firstSeen: new Date().toISOString() });
            saveCustomers(customers);
        }

        renderAdminLists(); // Update admin panel view
        alert(`‚úÖ Order confirmed! An advance of ‚Çπ${advanceAmount.toFixed(2)} has been recorded.`);
        const actionsDiv = document.getElementById('quoteActions');
        if (actionsDiv) actionsDiv.innerHTML = `<p class="font-bold text-green-700">Order has been confirmed successfully!</p>`;
    } else {
        alert('Error: Could not find the quote to confirm.');
    }
}

function markOrderCompleted(quoteId) {
    if (!confirm('Are you sure you want to mark this order as completed?')) return;
    let quotes = loadSavedQuotes();
    const quoteIndex = quotes.findIndex(q => q.id === quoteId);
    if (quoteIndex !== -1) {
        quotes[quoteIndex].status = 'completed';
        saveQuotesToStorage(quotes);
        renderAdminLists(); // Re-render the lists
    } else {
        alert('Error: Could not find the order to update.');
    }
}

/* Admin modal: safer show/hide */
function openRateEditor() {
    const pass = prompt('Enter admin password:');
    if (pass !== '6969') { alert('Wrong password'); return; }
    buildRateEditorFields();
    renderAdminLists();
    showRateEditorTab('rates');
    const m = document.getElementById('rateEditorModal');
    if (!m) return alert('Admin modal element missing');
    m.classList.remove('hidden');
    m.classList.add('flex');
    m.style.display = 'flex';

    // Set the date input to today's date by default when opening the modal
    const dateInput = document.getElementById('reportPrintDate');
    if (dateInput) dateInput.valueAsDate = new Date();

}
function closeRateEditor() {
    const m = document.getElementById('rateEditorModal');
    if (!m) return;
    m.classList.add('hidden');
    m.classList.remove('flex');
    m.style.display = '';
}

function showRateEditorTab(tab) {
    document.getElementById('ratesContent')?.classList.toggle('hidden', tab !== 'rates');
    document.getElementById('quotesContent')?.classList.toggle('hidden', tab !== 'quotes');
    document.getElementById('ordersContent')?.classList.toggle('hidden', tab !== 'orders');
    document.getElementById('customersContent')?.classList.toggle('hidden', tab !== 'customers');
    document.getElementById('dailyReportsContent')?.classList.toggle('hidden', tab !== 'dailyReports');

    document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(`${tab}TabBtn`);
    if (activeBtn) activeBtn.classList.add('active');
}
 
function buildRateEditorFields() {
    const c = document.getElementById('rateEditorFields');
    if (!c) return;
    let html = '<div class="admin-section-card"><h4 class="font-bold text-xl mb-4 text-gray-800">üí∞ Roofing Rates (per kg)</h4><div class="grid md:grid-cols-2 gap-4">';
    Object.keys(products.roofing.brands).forEach(k => {
        const name = `roofing-${k.replace(/\s+/g, '__')}`;
        html += `<div class="flex gap-3 items-center"><label class="w-48 font-semibold text-gray-700">${k}</label><input name="${name}" type="number" step="0.01" value="${products.roofing.brands[k].rate}" class="admin-input p-2 rounded-lg w-32"></div>`;
    });
    html += '</div></div>';

    html += '<div class="admin-section-card"><h4 class="font-bold text-xl mb-4 text-gray-800">üîß Pipe Rates (per kg)</h4><div class="grid md:grid-cols-2 gap-4">';
    Object.keys(products.pipes.sizes).forEach(s => {
        const name = `pipes-${s.replace(/\s+/g, '__')}`;
        html += `<div class="flex gap-3 items-center"><label class="w-48 font-semibold text-gray-700">${s}</label><input name="${name}" type="number" step="0.01" value="${products.pipes.sizes[s].rate || 0}" class="admin-input p-2 rounded-lg w-32"></div>`;
    });
    html += '</div></div>';

    html += '<div class="admin-section-card"><h4 class="font-bold text-xl mb-4 text-gray-800">‚öôÔ∏è Other Rates</h4><div class="space-y-4">';
    html += `<div class="flex gap-3 items-center"><label class="w-48 font-semibold text-gray-700">‚Ü™Ô∏è Bending Charge</label><input name="bending-rate" type="number" step="0.01" value="${products.bendingRate}" class="admin-input p-2 rounded-lg w-32"></div>`;
    html += `<div class="flex gap-3 items-center"><label class="w-48 font-semibold text-gray-700">Screws (per piece)</label><input name="screws-rate" type="number" step="0.01" value="${products.screws.rate}" class="admin-input p-2 rounded-lg w-32"></div>`;
    html += '</div></div>';
    c.innerHTML = html;
    const form = document.getElementById('rateEditorForm');
    if (form) form.onsubmit = saveRates;
}

function saveRates(e) {
    if (e && typeof e.preventDefault === 'function') e.preventDefault();
    const fd = new FormData(document.getElementById('rateEditorForm'));
    Object.keys(products.roofing.brands).forEach(k => {
        const n = `roofing-${k.replace(/\s+/g, '__')}`, v = parseFloat(fd.get(n));
        if (!isNaN(v)) products.roofing.brands[k].rate = v;
    });
    Object.keys(products.pipes.sizes).forEach(s => {
        const n = `pipes-${s.replace(/\s+/g, '__')}`, v = parseFloat(fd.get(n));
        if (!isNaN(v)) products.pipes.sizes[s].rate = v;
    });
    const sc = parseFloat(fd.get('screws-rate'));
    if (!isNaN(sc)) products.screws.rate = sc;
    const br = parseFloat(fd.get('bending-rate'));
    if (!isNaN(br)) products.bendingRate = br;
    updateProductFields();
    renderItems();
    closeRateEditor();
    alert('‚úÖ Rates saved successfully!');
}

function renderAdminLists() {
    const allQuotes = loadSavedQuotes();
    const pendingList = document.getElementById('savedQuotesList');
    const confirmedList = document.getElementById('confirmedOrdersList');
    const customersListContainer = document.getElementById('customersContent');
    const dailyReportsListContainer = document.getElementById('dailyReportsList');
    const dailyExitsListContainer = document.getElementById('dailyExitsList');

    const pendingQuotes = allQuotes.filter(q => q.status === 'quoted');
    if (pendingList) {
        if (!pendingQuotes.length) {
            pendingList.innerHTML = '<p class="text-gray-600">No pending quotes.</p>';
        } else {
            pendingList.innerHTML = pendingQuotes.map(q => `<div class="admin-section-card flex justify-between items-start">
            <div>
                <div class="font-bold text-lg text-gray-800">${q.customerName} <span class="text-sm font-normal text-gray-500">(#${q.id})</span></div>
                <div class="text-sm text-gray-600 mt-1">${q.phone} &bull; ${new Date(q.timestamp).toLocaleString()}</div>
                <div class="mt-3 font-bold text-blue-700">Total: ‚Çπ${Number(q.total).toFixed(2)} <span class="font-normal text-gray-600">(${q.items.length} items)</span></div>
            </div>
            <button class="px-4 py-2 bg-red-100 text-red-700 rounded-lg font-bold hover:bg-red-200 transition" onclick="deleteSavedQuote('${q.id}')">
                <i class="bi bi-trash-fill"></i> Delete
            </button>
        </div>`).join('');
        }
    }

    const confirmedOrders = allQuotes.filter(q => q.status === 'confirmed' || q.status === 'completed');
    if (confirmedList) {
        if (!confirmedOrders.length) {
            confirmedList.innerHTML = '<p class="text-gray-600">No confirmed orders.</p>';
        } else {
            confirmedList.innerHTML = confirmedOrders.map(q => {
                let statusBadge, actionButton;
                if (q.status === 'completed') {
                    statusBadge = `<span class="ml-2 text-xs font-bold text-white bg-gray-500 px-2 py-1 rounded-full">COMPLETED</span>`;
                    actionButton = `<button disabled class="px-4 py-2 bg-gray-300 text-gray-500 rounded-lg font-bold cursor-not-allowed flex items-center gap-2"><i class="bi bi-check-circle-fill"></i>Completed</button>`;
                } else { // confirmed
                    statusBadge = `<span class="ml-2 text-xs font-bold text-white bg-green-600 px-2 py-1 rounded-full">CONFIRMED</span>`;
                    actionButton = `<button onclick="markOrderCompleted('${q.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2"><i class="bi bi-check2-square"></i> Mark Completed</button>`;
                }
                const advanceInfo = `<div class="mt-1 text-sm font-semibold text-green-700">Advance Paid: ‚Çπ${Number(q.advancePaid).toFixed(2)}</div>`;

                return `<div class="admin-section-card ${q.status === 'completed' ? 'opacity-70' : ''}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="font-bold text-lg text-gray-800">${q.customerName}${statusBadge}</div>
                            <div class="text-sm text-gray-600 mt-1">${q.phone} &bull; ${new Date(q.timestamp).toLocaleString()}</div>
                        </div>
                        ${actionButton}
                    </div>
                    <div class="flex justify-between items-end mt-4 pt-4 border-t border-gray-200">
                        <div>
                            <span class="font-bold text-blue-700">Total: ‚Çπ${Number(q.total).toFixed(2)}</span>
                            <span class="text-gray-600 mx-2">|</span>
                            <span class="font-semibold text-green-700">Advance: ‚Çπ${Number(q.advancePaid).toFixed(2)}</span>
                        </div>
                        <button class="px-3 py-1 bg-red-100 text-red-700 rounded-lg font-bold hover:bg-red-200 transition text-xs" onclick="deleteSavedQuote('${q.id}')">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>`;
            }).join('');
        }
    }

    // Render Customers List
    if (customersListContainer) {
        const customers = loadCustomers();
        let customerHtml = `
            <div class="flex justify-between items-center mb-4">
                <button onclick="clearAllCustomers()" class="btn-3d px-4 py-2 bg-red-600 text-white rounded-lg font-bold text-sm">
                    <i class="bi bi-trash-fill"></i> Clear All Customers
                </button>
                <input type="text" id="customerSearchInput" onkeyup="renderAdminLists()" placeholder="Search customers by name or phone..." class="w-full p-3 admin-input rounded-lg">
            </div>
            <div id="customerList" class="space-y-4"></div>
            <div id="customerHistory" class="hidden"></div>
        `;
        customersListContainer.innerHTML = customerHtml;

        const searchFilter = (document.getElementById('customerSearchInput')?.value || '').toLowerCase();
        const filteredCustomers = customers.filter(c => 
            c.name.toLowerCase().includes(searchFilter) || c.phone.includes(searchFilter)
        );

        const customerListEl = document.getElementById('customerList');
        if (customerListEl) {
            if (!filteredCustomers.length) {
                customerListEl.innerHTML = '<p class="text-gray-600">No customers found.</p>';
            } else {
                customerListEl.innerHTML = filteredCustomers.map(c => `
                    <div class="admin-section-card">
                        <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-lg text-gray-800">${c.name}</div>
                            <div class="text-sm text-gray-600 mt-1">${c.phone}</div>
                        </div>
                            <button class="px-3 py-1 bg-red-100 text-red-700 rounded-lg font-bold hover:bg-red-200 transition text-xs" onclick="deleteCustomer('${c.phone}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="text-right mt-4">
                            <button onclick="showCustomerHistory('${c.phone}')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-bold hover:bg-blue-200 transition text-sm">View History</button>
                        </div>
                    </div>
                `).join('');
            }
        }
    }

    // Render Daily Reports List
    if (dailyReportsListContainer) {
        const reports = (JSON.parse(localStorage.getItem(DAILY_REPORTS_KEY) || '[]')).filter(r => isToday(new Date(r.timestamp)));
        if (!reports.length) {
            dailyReportsListContainer.innerHTML = '<p class="text-gray-600">No daily entries found.</p>';
        } else {
            dailyReportsListContainer.innerHTML = reports.map(report => {
                const totalAmount = report.items.reduce((sum, item) => sum + item.amount, 0);
                const itemsTableId = `report-items-${report.id}`;
                const itemsHtml = `
                    <div id="${itemsTableId}" class="hidden mt-4 pt-4 border-t border-gray-200">
                        <h5 class="font-semibold text-gray-700 mb-2">Itemized Details:</h5>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">Item</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-600">Weight</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-600">Rate</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-600">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${report.items.map(item => `
                                        <tr class="border-b">
                                            <td class="px-3 py-2"><div class="font-semibold">${item.name}</div><div class="text-xs text-gray-500">${item.details || ''}</div></td>
                                            <td class="px-3 py-2 text-right">${item.weight > 0 ? item.weight + ' kg' : 'N/A'}</td>
                                            <td class="px-3 py-2 text-right">‚Çπ${item.rate.toFixed(2)}${item.productType === 'polycarbonate' ? '/sq.ft' : ''}</td>
                                            <td class="px-3 py-2 text-right font-bold">‚Çπ${item.amount.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;

                return `
                    <div class="admin-section-card">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="font-bold text-lg text-gray-800">${report.customerName}</div>
                                <div class="text-sm text-gray-600 mt-1">${report.phone || 'No contact'} &bull; ${new Date(report.timestamp).toLocaleString()}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-xl text-blue-700">‚Çπ${totalAmount.toFixed(2)}</div>
                                <button onclick="toggleReportDetails('${report.id}')" class="text-sm text-blue-600 hover:underline font-semibold mt-1">View ${report.items.length} Items</button>
                            </div>
                        </div>
                        ${itemsHtml}
                    </div>`;
            }).join('');
        }
    }

    // Render Daily Exits List (single consolidated block)
    if (dailyExitsListContainer) {
        const exits = (JSON.parse(localStorage.getItem(DAILY_EXITS_KEY) || '[]')).filter(e => isToday(new Date(e.timestamp)));
        if (!exits.length) {
            dailyExitsListContainer.innerHTML = '<p class="text-gray-600">No expenditures found for today.</p>';
        } else {
            dailyExitsListContainer.innerHTML = exits.map(exit => `
                <div class="admin-section-card">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-800">${exit.description}</span>
                        <span class="font-bold text-lg text-red-600">- ‚Çπ${exit.amount.toFixed(2)}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">${new Date(exit.timestamp).toLocaleTimeString()}</div>
                </div>
            `).join('');
        }
    }
    updateQuoteCounts();
}

function showCustomerHistory(phone) {
    const customerListEl = document.getElementById('customerList');
    const searchInputEl = document.getElementById('customerSearchInput');
    const historyDiv = document.getElementById('customerHistory');
    if (customerListEl) customerListEl.classList.add('hidden');
    if (searchInputEl) searchInputEl.classList.add('hidden');
    if (!historyDiv) return;

    const allQuotes = loadSavedQuotes();
    const customerOrders = allQuotes.filter(q => q.phone === phone);
    historyDiv.classList.remove('hidden');
    historyDiv.innerHTML = `<button onclick="renderAdminLists()" class="mb-4 px-4 py-2 bg-gray-300 rounded-lg font-bold">‚Üê Back to Customers</button>
        <h3 class="text-2xl font-bold mb-4">Order History for ${customerOrders[0]?.customerName || phone}</h3>
        <div class="space-y-4">${customerOrders.map(q => `<div class="admin-section-card"><div><strong>ID:</strong> ${q.id}</div><div><strong>Date:</strong> ${new Date(q.timestamp).toLocaleString()}</div><div><strong>Total:</strong> ‚Çπ${q.total.toFixed(2)}</div><div><strong>Status:</strong> ${q.status}</div></div>`).join('') || '<p>No history found.</p>'}</div>`;
}

function deleteSavedQuote(id) {
    if (!confirm('Delete this quote?')) return;
    let arr = loadSavedQuotes();
    arr = arr.filter(q => q.id !== id);
    saveQuotesToStorage(arr);
    renderAdminLists();
}

function clearAllSavedQuotes() {
    const quotes = loadSavedQuotes();
    if (quotes.length === 0) {
       

        alert('There are no saved quotes to clear.');

        return;
    }
    if (confirm(`Are you sure you want to delete all ${quotes.length} saved quotes? This action cannot be undone.`)) {
        saveQuotesToStorage([]); // Clear the array in localStorage
        renderAdminLists(); // Re-render the list
        alert('All saved quotes have been deleted.');
    }
}

function clearAllConfirmedOrders() {
    const allQuotes = loadSavedQuotes();
    const confirmedCount = allQuotes.filter(q => q.status === 'confirmed' || q.status === 'completed').length;
    if (confirmedCount === 0) {
        alert('There are no confirmed orders to clear.');
        return;
    }
    if (confirm(`Are you sure you want to delete all ${confirmedCount} confirmed and completed orders? This action cannot be undone.`)) {
        const pendingQuotes = allQuotes.filter(q => q.status === 'quoted');
        saveQuotesToStorage(pendingQuotes);
        renderAdminLists();
        alert('All confirmed orders have been cleared.');
    }
}

function clearAllCustomers() {
    const customers = loadCustomers();
    if (customers.length === 0) { alert('There are no customers to clear.'); return; }
    if (confirm(`Are you sure you want to delete all ${customers.length} customers? This action cannot be undone.`)) {
        localStorage.removeItem(CUSTOMERS_KEY);
        renderAdminLists();
        alert('All customers have been cleared.');
    }
}

function deleteCustomer(phone) {
    if (!confirm('Delete this customer and their history?')) return;
    let customers = loadCustomers();
    customers = customers.filter(c => c.phone !== phone);
    saveCustomers(customers);
    // Also remove quotes for that customer (optional)
    let quotes = loadSavedQuotes();
    quotes = quotes.filter(q => q.phone !== phone);
    saveQuotesToStorage(quotes);
    renderAdminLists();
}

function renderGallery() {
    const grid = document.getElementById('galleryGrid');
    if (!grid) return;

    grid.innerHTML = galleryProjects.map(project => `
        <div class="project-card h-96 group">
            <img src="${project.image}" alt="${project.title}" class="w-full h-full object-cover">
            <div class="project-card-overlay">
                <div class="project-card-content">
                    <div class="transform transition-all duration-300 opacity-0 group-hover:opacity-100 h-0 group-hover:h-auto mb-4">
                        <p class="text-gray-300 text-sm mb-2">${project.description}</p>
                        <div class="font-semibold text-sm mb-2">Products Used:</div>
                        <div class="flex flex-wrap gap-2">
                            ${project.productsUsed.map(p => `<span class="bg-white/20 text-white text-xs font-bold px-2 py-1 rounded-full">${p}</span>`).join('')}
                        </div>
                    </div>
                    <h3 class="text-2xl font-bold">${project.title}</h3>
                </div>
            </div>
        </div>
    `).join('');
}

/* --- Image Catalog Slider Functions --- */
function showImageCatalog(productType) {
    const product = products[productType];
    if (!product || !product.images || product.images.length === 0) {
        alert('No images available for this product.');
        return;
    }

    const titleEl = document.getElementById('catalogTitle');
    const slidesContainer = document.getElementById('catalogSlidesContainer');
    const dotsContainer = document.getElementById('catalogDotsContainer');

    if (titleEl) titleEl.textContent = product.name;
    if (slidesContainer) {
        slidesContainer.innerHTML = product.images.map((imgUrl, index) => `
            <div class="catalog-slide ${index === 0 ? 'active' : ''}" data-slide-index="${index}">
                <img src="${imgUrl}" alt="${product.name} image ${index + 1}">
            </div>
        `).join('');
    }
    if (dotsContainer) {
        dotsContainer.innerHTML = product.images.map((_, index) => `
            <button onclick="goToCatalogSlide(${index})" class="w-3 h-3 ${index === 0 ? 'bg-white' : 'bg-white/50'} rounded-full cursor-pointer transition"></button>
        `).join('');
    }

    currentCatalogSlide = 0;
    displayPage('imageCatalog'); // Use displayPage to not affect history
    startAutoCatalogSlide();
}

function closeImageCatalog() {
    showPage('quotation');
    stopAutoCatalogSlide();
}

function updateCatalogSlider() {
    document.querySelectorAll('.catalog-slide').forEach((slide, index) => {
        slide.classList.toggle('active', index === currentCatalogSlide);
    });
    document.querySelectorAll('#catalogDotsContainer button').forEach((dot, index) => {
        dot.classList.toggle('bg-white', index === currentCatalogSlide);
        dot.classList.toggle('bg-white/50', index !== currentCatalogSlide);
    });
    startAutoCatalogSlide(); // Restart timer on manual navigation
}

function nextCatalogSlide() {
    const slideCount = document.querySelectorAll('.catalog-slide').length;
    if (slideCount === 0) return;
    currentCatalogSlide = (currentCatalogSlide + 1) % slideCount;
    updateCatalogSlider();
}

function prevCatalogSlide() {
    const slideCount = document.querySelectorAll('.catalog-slide').length;
    if (slideCount === 0) return;
    currentCatalogSlide = (currentCatalogSlide - 1 + slideCount) % slideCount;
    updateCatalogSlider();
}

function goToCatalogSlide(n) {
    currentCatalogSlide = n;
    updateCatalogSlider();
}

function startAutoCatalogSlide() {
    stopAutoCatalogSlide(); // Clear any existing timer
    const slideCount = document.querySelectorAll('.catalog-slide').length;
    if (slideCount > 1) {
        catalogSlideTimer = setInterval(nextCatalogSlide, 4000); // Change slide every 4 seconds
    }
}

function stopAutoCatalogSlide() {
    if (catalogSlideTimer) {
        clearInterval(catalogSlideTimer);
        catalogSlideTimer = null;
    }
}

function initializeScrollAnimations() {
    const scrollElements = document.querySelectorAll('.scroll-reveal');
    if (!scrollElements.length) return;

    const elementObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
            } else {
                entry.target.classList.remove('visible');
            }
        });
    }, { threshold: 0.1 }); // Trigger when 10% of the element is visible

    scrollElements.forEach(el => elementObserver.observe(el));
}

/* init on DOM ready */
document.addEventListener('DOMContentLoaded', async () => {
    loadLocalProducts();

    const qForm = document.getElementById('quotationForm');
    if (qForm) qForm.addEventListener('submit', calculateQuote);
    // ensure exits are rendered on load
    renderDailyExitsPage();
    // Handle browser back/forward navigation
    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.page) {
            displayPage(event.state.page);
        } else {
            displayPage('quotation');
        }
    });
    // Handle initial page load based on URL hash
    const initialPage = window.location.hash.substring(1) || 'quotation';
    history.replaceState({ page: initialPage }, '', `#${initialPage}`);
    displayPage(initialPage);

    updateProductFields();
    updateDailyReportProductFields(); // Initialize daily report fields
    // removed call to non-existent showDailyBookTab to avoid runtime errors

    handleEnterAsTab(); // Enable 'Enter' key to move to the next field
    initializeScrollAnimations();

});

function suggestCustomers(event) {
    const input = event.target;
    const suggestionsContainer = document.getElementById('customerSuggestions');
    const value = input.value.toLowerCase();
    const customers = loadCustomers();

    if (!value) {
        suggestionsContainer.innerHTML = '';
        suggestionsContainer.classList.add('hidden');
        return;
    }

    const filteredCustomers = customers.filter(c =>
        c.name.toLowerCase().includes(value) || c.phone.includes(value)
    );

    if (filteredCustomers.length > 0) {
        suggestionsContainer.innerHTML = filteredCustomers.map(c =>
            `<div class="p-3 hover:bg-gray-100 cursor-pointer" onclick="selectCustomer('${c.name}', '${c.phone}')">
                <p class="font-semibold">${c.name}</p>
                <p class="text-sm text-gray-500">${c.phone}</p>
            </div>`
        ).join('');
        suggestionsContainer.classList.remove('hidden');
    } else {
        suggestionsContainer.innerHTML = '';
        suggestionsContainer.classList.add('hidden');
    }
}

function filterProducts() {
    const filter = document.getElementById('productSearchInput')?.value.toUpperCase() || '';
    const tables = [
        { tbody: document.getElementById('roofingTableBody') },
        { tbody: document.getElementById('pipesTableBody') }
    ];

    tables.forEach(table => {
        if (!table.tbody) return;
        const rows = table.tbody.getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const rowText = row.textContent || row.innerText;
            row.style.display = rowText.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
        }
    });
}

function selectCustomer(name, phone) {
    const form = document.getElementById('quotationForm');
    if (form) {
        form.customerName.value = name;
        form.phone.value = phone;
    }
    const suggestionsContainer = document.getElementById('customerSuggestions');
    suggestionsContainer.innerHTML = '';
    suggestionsContainer.classList.add('hidden');
}

function updateDailyReportProductFields() {
    const productType = document.querySelector('[name="reportProductType"]')?.value || 'roofing';
    const fieldsContainer = document.getElementById('dailyReportProductFields');
    if (!fieldsContainer) return;
    let html = '';

    if (productType === 'roofing') {
        html = `<div class="grid md:grid-cols-5 gap-4 items-end">
            <div><label class="block mb-1 font-semibold text-sm">Brand</label><select name="report_brand" class="w-full p-3 border-2 rounded-lg">${Object.keys(products.roofing.brands).map(b => `<option value="${b}">${b}</option>`).join('')}</select></div>
            <div><label class="block mb-1 font-semibold text-sm">Colour</label><select name="report_color" class="w-full p-3 border-2 rounded-lg"></select></div>
            <div><label class="block mb-1 font-semibold text-sm">Length (ft)</label><input type="number" name="report_length" class="w-full p-3 border-2 rounded-lg" value="13"></div>
            <div><label class="block mb-1 font-semibold text-sm">Qty</label><input type="number" name="report_quantity" class="w-full p-3 border-2 rounded-lg" value="1"></div>
            <div class="flex items-center gap-2 pb-3"><input type="checkbox" id="report_addBending" name="report_addBending" class="h-5 w-5 rounded"><label for="report_addBending" class="font-semibold text-gray-700 text-sm">Add Bending</label></div>
        </div>`;
    } else if (productType === 'pipes') {
        html = `<div class="grid md:grid-cols-2 gap-4">
            <div><label class="block mb-1 font-semibold text-sm">Size</label><select name="report_size" class="w-full p-3 border-2 rounded-lg">${Object.keys(products.pipes.sizes).map(s => `<option value="${s}">${s}</option>`).join('')}</select></div>
            <div><label class="block mb-1 font-semibold text-sm">Qty</label><input type="number" name="report_quantity" class="w-full p-3 border-2 rounded-lg" value="1"></div>
        </div>`;
    } else if (productType === 'polycarbonate') {
        const options = products.polycarbonate.types.map((p, i) => `<option value="${i}">${p.width}'W / ${p.thickness}mm</option>`).join('');
        html = `<div class="grid md:grid-cols-3 gap-4">
            <div><label class="block mb-1 font-semibold text-sm">Sheet Type</label><select name="report_polyType" class="w-full p-3 border-2 rounded-lg">${options}</select></div>
            <div><label class="block mb-1 font-semibold text-sm">Length (ft)</label><input type="number" name="report_length" class="w-full p-3 border-2 rounded-lg" value="10"></div>
            <div><label class="block mb-1 font-semibold text-sm">Qty</label><input type="number" name="report_quantity" class="w-full p-3 border-2 rounded-lg" value="1"></div>
        </div>`;
    } else { // Screws
        html = `<div><label class="block mb-1 font-semibold text-sm">Qty</label><input type="number" name="report_quantity" class="w-full p-3 border-2 rounded-lg" value="10"></div>`;
    }
    fieldsContainer.innerHTML = html;
    // Need a separate color updater for the report form
    if (productType === 'roofing') {
        const brandSelect = document.querySelector('[name="report_brand"]');
        if (brandSelect) {
            brandSelect.onchange = updateDailyReportColorOptions;
            updateDailyReportColorOptions();
        }
    }

    // Show/hide weight input based on product type
    const weightContainer = document.getElementById('reportWeightContainer');
    const rateLabel = document.getElementById('reportRateLabel');
    if (weightContainer && rateLabel) {
        weightContainer.style.display = (productType === 'polycarbonate' || productType === 'screws') ? 'none' : 'block';
        rateLabel.textContent = (productType === 'polycarbonate') ? 'Rate (per sq.ft)' : 'Rate (per kg/pc)';
    }
}

function updateDailyReportColorOptions() {
    const brand = document.querySelector('[name="report_brand"]')?.value;
    const colorSelect = document.querySelector('[name="report_color"]');
    if (!brand || !colorSelect) return;
    const brandData = products.roofing.brands[brand];
    colorSelect.innerHTML = (brandData?.colors || []).map(c => `<option value="${c}">${c}</option>`).join('');
}

function addDailyReportItem() {
    const form = document.getElementById('dailyReportForm');
    const productType = form.reportProductType.value;
    let weight = parseFloat(document.getElementById('reportItemWeight').value);
    const rate = parseFloat(document.getElementById('reportItemRate').value);

    // Rate is always required
    if (isNaN(rate)) { alert('Please enter a valid Rate for the item.'); return; }
    
    let name = 'Item';
    let details = '';

    if (productType === 'roofing') {
        name = 'Roofing Sheet';
        details = `${form.report_brand.value} ‚Ä¢ ${form.report_color.value} ‚Ä¢ ${form.report_length.value}ft ‚Ä¢ ${form.report_quantity.value}pcs`;

        // If bending is requested, add it as a separate item
        const addBending = form.report_addBending?.checked;
        if (addBending) {
            const qty = parseInt(form.report_quantity.value) || 0;
            const bendingRate = products.bendingRate || 0;
            const bendingItem = { name: '‚Ü™Ô∏è Bending Charge', details: `For ${qty} roofing sheets`, weight: 0, rate: bendingRate, amount: bendingRate * qty, productType: 'bending' };
            dailyReportItems.push(bendingItem);
        }
    } else if (productType === 'pipes') {
        name = 'MS Pipe';
        details = `${form.report_size.value} ‚Ä¢ ${form.report_quantity.value}pcs`;
    } else if (productType === 'polycarbonate') {
        const polyType = products.polycarbonate.types[+form.report_polyType.value];
        const length = parseFloat(form.report_length.value);
        const quantity = parseInt(form.report_quantity.value) || 0;
        name = 'Polycarbonate';
        details = `${polyType.width}'x${length}' (${polyType.thickness}mm) ‚Ä¢ ${quantity}pcs`;
        weight = 0;
    } else if (productType === 'screws') {
        name = 'Screws';
        details = `${form.report_quantity.value} pcs`;
        weight = 0; // Weight is not applicable
    }

    // Validate weight for products that require it
    if (productType === 'roofing' || productType === 'pipes') {
        if (isNaN(weight)) { alert('Please enter a valid Weight for this product type.'); return; }
    }

    const amount = calculateDailyItemAmount(productType, form);

    dailyReportItems.push({ name, details, weight, rate, amount, productType });

    renderDailyReportItems();

    // Clear inputs
    const weightEl = document.getElementById('reportItemWeight');
    const rateEl = document.getElementById('reportItemRate');
    if (weightEl) weightEl.value = '';
    if (rateEl) rateEl.value = '';

    // Rebuild product fields (keeps UI consistent) then focus Product Type
    updateDailyReportProductFields();
    const prodSelect = document.querySelector('[name="reportProductType"]');
    if (prodSelect) {
        prodSelect.focus();
    }
}

function toggleReportDetails(reportId) {
    const itemsTable = document.getElementById(`report-items-${reportId}`);
    if (!itemsTable) return;
    itemsTable.classList.toggle('hidden');
}

function suggestDailyReportCustomers(event) {
    const input = event.target;
    const suggestionsContainer = document.getElementById('dailyReportCustomerSuggestions');
    const value = (input.value || '').toLowerCase();
    const customers = loadCustomers();

    if (!value) {
        suggestionsContainer.innerHTML = '';
        suggestionsContainer.classList.add('hidden');
        return;
    }

    let suggestions = [];
    // Always add "Cash Sale" if it matches the search term
    if ('cash sale'.includes(value)) {
        suggestions.push({ name: 'Cash Sale', phone: 'N/A' });
    }

    const filteredCustomers = customers.filter(c =>
        c.name.toLowerCase().includes(value) || c.phone.includes(value)
    );

    // Combine cash sale with other customers, ensuring no duplicates by name
    const finalSuggestions = [...suggestions, ...filteredCustomers.filter(c => c.name.toLowerCase() !== 'cash sale')];

    if (finalSuggestions.length > 0) {
        suggestionsContainer.innerHTML = finalSuggestions.map(c =>
            `<div class="p-3 hover:bg-gray-100 cursor-pointer" onclick="selectDailyReportCustomer('${c.name}', '${c.phone}')">
                <p class="font-semibold">${c.name}</p>
                <p class="text-sm text-gray-500">${c.phone}</p>
            </div>`
        ).join('');
        suggestionsContainer.classList.remove('hidden');
    } else {
        suggestionsContainer.innerHTML = '';
        suggestionsContainer.classList.add('hidden');
    }
}

function printQuote() {
    const form = document.getElementById('quotationForm');
    const fd = form ? new FormData(form) : new FormData();
    const customer = fd.get('customerName') || '';
    const phone = fd.get('phone') || '';
    const date = new Date().toLocaleDateString();

    const companyName = 'GOTORI STEEL';
    const address = 'shop no.184/P2 , NANDUR INDUSTRIAL AREA ROAD NO.8,SHABAD ROAD,KALABURGI-585102  STATE NAME:KARNATAKA,CODE:29';
    const gst = 'GSTIN: 29AHYPG7206R1ZA'; 

    let rows = '';
    quoteItems.forEach((it, i) => {
        rows += `
            <tr>
                <td style="padding:8px;border:1px solid #ddd;text-align:center">${i+1}</td>
                <td style="padding:8px;border:1px solid #ddd">
                    <div style="font-weight:700">${it.type}</div>
                    <div style="font-size:12px;color:#444">${it.details}</div>
                </td>
                <td style="padding:8px;border:1px solid #ddd;text-align:center">${it.quantity}</td>
                <td style="padding:8px;border:1px solid #ddd;text-align:right">${it.weight > 0 ? Number(it.weight).toFixed(2) + ' kg' : 'N/A'}</td>
                <td style="padding:8px;border:1px solid #ddd;text-align:right">‚Çπ${Number(it.unitRate).toFixed(2)}</td>
                <td style="padding:8px;border:1px solid #ddd;text-align:right;font-weight:bold;">‚Çπ${Number(it.total).toFixed(2)}</td>
            </tr>`;
    });

    const total = quoteItems.reduce((s, it) => s + (Number(it.total) || 0), 0);
    const gstAmount = total * 0.18; // 18% GST
    const grandTotal = total + gstAmount;

    const html = `<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Quotation - ${companyName}</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;color:#222;padding:20px}
  .header{text-align:center;margin-bottom:12px}
  .company{font-size:28px;font-weight:800}
  .muted{color:#555;margin-top:4px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #ddd;padding:8px}
  th{background:#f5f5f5;text-align:left}
  .right{text-align:right}
  .box{border:1px solid #ddd;padding:12px;margin-top:12px}
  .seal{width:160px;height:70px;border:2px solid #222;display:inline-block;margin-left:10px;text-align:center;line-height:70px;font-weight:700}
  @media print{
    body{padding:8mm}
    .no-print{display:none}
  }
</style>
</head>
<body>
  <div class="header">
    <div class="company">${companyName}</div>
    <div class="muted">${address}</div>
    <div class="muted">${gst}</div>
    <div style="margin-top:8px">Date: ${date}</div>
  </div>

  <div class="box">
    <strong>To:</strong> ${customer} <br>
    <strong>Phone:</strong> ${phone}
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:6%">#</th>
        <th>Item & Details</th>
        <th style="width:8%" class="right">Qty</th>
        <th style="width:12%" class="right">Weight</th>
        <th style="width:12%" class="right">Rate (‚Çπ)</th>
        <th style="width:15%" class="right">Amount (‚Çπ)</th>
      </tr>
    </thead>
    <tbody>
      ${rows}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="5" style="padding:8px;border:1px solid #ddd;text-align:right;font-weight:800">Subtotal</td>
        <td style="padding:8px;border:1px solid #ddd;text-align:right;font-weight:800">‚Çπ${Number(total).toFixed(2)}</td>
      </tr>
      <tr>
        <td colspan="5" style="padding:8px;border:1px solid #ddd;text-align:right;font-weight:800">GST (18%)</td>
        <td style="padding:8px;border:1px solid #ddd;text-align:right;font-weight:800">‚Çπ${Number(gstAmount).toFixed(2)}</td>
      </tr>
      <tr>
        <td colspan="5" style="padding:8px;border:1px solid #ddd;text-align:right;font-weight:800">Grand Total</td>
        <td style="padding:8px;border:1px solid #ddd;text-align:right;font-weight:800">‚Çπ${Number(grandTotal).toFixed(2)}</td>
      </tr>
    </tfoot>
  </table>

  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-top:18px">
    <div style="flex:1">
      <div style="font-weight:700;margin-bottom:6px">Note:</div>
      <div style="border:1px solid #ddd;padding:10px;height:80px">This Amount is Excluding GST and Loading Charges Later it Will Be added While GST Billing</div>
    </div>
    <div style="width:240px;text-align:center;margin-left:18px">
      <div style="margin-bottom:18px">For ${companyName}</div>
      <div class="seal">Seal &amp; Sign</div>
    </div>
  </div>

  <div class="no-print" style="margin-top:18px;text-align:center">
    <button onclick="window.print()" style="padding:8px 14px;font-weight:700">Print</button>
  </div>
<script>document.body.addEventListener('wheel', e => { if (!e.ctrlKey) return; e.preventDefault(); return }, { passive: false })</script>
	</body>
</html>`;

    const win = window.open('', '_blank', 'width=900,height=700');
    if (!win) return alert('Please allow popups to print the quotation.');
    win.document.open();
    win.document.write(html);
    win.document.close();
    win.focus();
    setTimeout(() => { try { win.print(); } catch (e) { console.error(e); } }, 500);
}

function isToday(someDate) {
    const today = new Date();
    return someDate.getDate() === today.getDate() &&
           someDate.getMonth() === today.getMonth() &&
           someDate.getFullYear() === today.getFullYear();
}

function selectDailyReportCustomer(name, phone) {
    const form = document.getElementById('dailyReportForm');
    if (form) {
        form.reportCustomerName.value = name;
        form.reportPhone.value = phone;
    }
    const suggestionsContainer = document.getElementById('dailyReportCustomerSuggestions');
    suggestionsContainer.innerHTML = '';
    suggestionsContainer.classList.add('hidden');
}

function calculateDailyItemAmount(productType, form) {
    const rate = parseFloat(document.getElementById('reportItemRate').value) || 0;

    if (productType === 'polycarbonate') {
        const polyType = products.polycarbonate.types[+form.report_polyType.value];
        const length = parseFloat(form.report_length.value) || 0;
        const quantity = parseInt(form.report_quantity.value) || 0;
        return polyType.width * length * quantity * rate;
    } else if (productType === 'screws') {
        const quantity = parseInt(form.report_quantity.value) || 0;
        return quantity * rate;
    } else {
        // Default for roofing and pipes
        const weight = parseFloat(document.getElementById('reportItemWeight').value) || 0;
        return weight * rate;
    }
}

function renderDailyReportItems() {
    const listEl = document.getElementById('dailyReportItemsList');
    if (!listEl) return;
    if (!dailyReportItems.length) {
        listEl.innerHTML = '<p class="text-center text-gray-500 py-4">No items added yet.</p>';
        return;
    }
    listEl.innerHTML = `<div class="overflow-x-auto bg-gray-50 p-4 rounded-lg"><table class="w-full"><thead><tr class="text-left text-gray-600"><th class="px-4 py-2">Item</th><th class="px-4 py-2">Weight</th><th class="px-4 py-2">Rate</th><th class="px-4 py-2">Amount</th></tr></thead><tbody>${dailyReportItems.map(item => `
        <tr class="border-b"><td class="px-4 py-2"><div class="font-semibold">${item.name}</div><div class="text-sm text-gray-500">${item.details}</div></td><td class="px-4 py-2">${item.weight > 0 ? item.weight + ' kg' : 'N/A'}</td><td class="px-4 py-2">‚Çπ${item.rate.toFixed(2)} ${item.productType === 'polycarbonate' ? '/sq.ft' : ''}</td><td class="px-4 py-2 font-bold">‚Çπ${item.amount.toFixed(2)}</td></tr>
    `).join('')}</tbody></table></div>`;
}

function saveDailyReport() {
    const form = document.getElementById('dailyReportForm');
    const customerName = form.reportCustomerName.value;
    const phone = form.reportPhone.value;

    if (!customerName) {
        alert('Please enter a Customer Name (e.g., "Cash Sale" or actual customer name).');
        return;
    }
    if (!phone) {
        alert('Please enter a Contact Number for the customer.');
        return;
    }

    if (dailyReportItems.length === 0) {
        return alert('No items added to the daily report. Please add items before saving.');
    }

    const reportId = 'R' + Date.now();
    const newReport = {
        id: reportId,
        customerName,
        phone,
        items: dailyReportItems.map(item => ({
            name: item.name,
            details: item.details,
            weight: item.weight,
            rate: item.rate,
            amount: item.amount,
            productType: item.productType
        })),
        timestamp: new Date().toISOString()
    };

    // Save to localStorage
    const existingReports = JSON.parse(localStorage.getItem(DAILY_REPORTS_KEY) || '[]');
    existingReports.push(newReport);
    localStorage.setItem(DAILY_REPORTS_KEY, JSON.stringify(existingReports));

    alert('‚úÖ Daily report saved successfully!');
    dailyReportItems.length = 0; // Clear items
    renderDailyReportItems();
    const customerSelect = document.getElementById('customerSelect');
    if (customerSelect) customerSelect.value = ''; // Reset customer selection
    form.reset(); // Reset form fields
    updateDailyReportProductFields(); // Reset product fields
}

// --- NEW / FIXED: Exits + Print summary functions ---
function saveDailyExit() {
    const form = document.getElementById('dailyExitForm');
    if (!form) return alert('Exit form not found.');
    const description = (form.exitDescription.value || '').trim();
    const amount = parseFloat(form.exitAmount.value);

    if (!description || isNaN(amount) || amount <= 0) {
        alert('Please enter a valid description and a positive amount for the expenditure.');
        return;
    }

    const exits = JSON.parse(localStorage.getItem(DAILY_EXITS_KEY) || '[]');
    const newExit = { id: 'DE' + Date.now(), timestamp: new Date().toISOString(), description, amount };
    exits.unshift(newExit);
    localStorage.setItem(DAILY_EXITS_KEY, JSON.stringify(exits));

    alert('‚úÖ Expenditure saved successfully!');
    form.reset();
    renderDailyExitsPage();
    renderAdminLists(); // keep admin panel in sync
}

function renderDailyExitsPage() {
    const container = document.getElementById('dailyExitsListPage');
    if (!container) return;
    const exits = (JSON.parse(localStorage.getItem(DAILY_EXITS_KEY) || '[]')).filter(e => isToday(new Date(e.timestamp)));
    if (!exits.length) {
        container.innerHTML = '<p class="text-gray-600">No expenditures for today.</p>';
        return;
    }
    container.innerHTML = exits.map(ex => `
        <div class="admin-section-card flex justify-between items-center">
            <div>
                <div class="font-semibold text-gray-800">${ex.description}</div>
                <div class="text-xs text-gray-500">${new Date(ex.timestamp).toLocaleTimeString()}</div>
            </div>
            <div class="flex items-center gap-3">
                <div class="font-bold text-red-600">- ‚Çπ${ex.amount.toFixed(2)}</div>
                <button onclick="deleteDailyExit('${ex.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded-lg font-bold text-xs">Delete</button>
            </div>
        </div>
    `).join('');
}

function deleteDailyExit(id) {
    if (!confirm('Delete this expenditure?')) return;
    const exits = (JSON.parse(localStorage.getItem(DAILY_EXITS_KEY) || '[]')).filter(e => e.id !== id);
    localStorage.setItem(DAILY_EXITS_KEY, JSON.stringify(exits));
    renderDailyExitsPage();
    renderAdminLists();
}

function clearAllDailyReports() {
    const reports = JSON.parse(localStorage.getItem(DAILY_REPORTS_KEY) || '[]');
    const exits = JSON.parse(localStorage.getItem(DAILY_EXITS_KEY) || '[]');

    if (reports.length === 0 && exits.length === 0) {
        alert('There are no daily reports or expenditures to clear.');
        return;
    }
    const totalEntries = reports.length + exits.length;
    if (confirm(`Are you sure you want to delete all ${totalEntries} daily entries (sales and expenditures)? This action cannot be undone.`)) {
        localStorage.removeItem(DAILY_REPORTS_KEY);
        localStorage.removeItem(DAILY_EXITS_KEY);
        renderAdminLists();
        renderDailyExitsPage(); // Also re-render the exits on the main page
        alert('All daily reports and expenditures have been successfully cleared.');
    }
}

function printDailySummary() {
    const dateInput = document.getElementById('reportPrintDate');
    if (!dateInput || !dateInput.value) {
        alert('Please select a date to print the report for.');
        return;
    }
    const targetDateStr = dateInput.value; // YYYY-MM-DD
    const targetDate = new Date(targetDateStr + 'T00:00:00'); // Treat as local time

    const allReports = JSON.parse(localStorage.getItem(DAILY_REPORTS_KEY) || '[]');
    const todaysReports = allReports.filter(report => isSameDay(new Date(report.timestamp), targetDate));

    const allExits = JSON.parse(localStorage.getItem(DAILY_EXITS_KEY) || '[]');
    const todaysExits = allExits.filter(exit => isSameDay(new Date(exit.timestamp), targetDate));

    if (todaysReports.length === 0 && todaysExits.length === 0) {
        const formattedDate = targetDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        alert(`No sales or expenditures found for ${formattedDate}.`);
        return;
    }

    let totalDaySales = 0;
    let totalDayExpenditure = 0;
    let totalRoofingKg = 0;
    let totalPipesKg = 0;
    let totalPolycarbonateSqFt = 0;
    let totalScrewsPcs = 0;

    const tableRowsHtml = todaysReports.map((report, index) => {
        const entryTotal = report.items.reduce((sum, item) => sum + (item.amount || 0), 0);
        totalDaySales += entryTotal;
        const productTypes = [...new Set(report.items.map(item => item.name.replace('‚Ü™Ô∏è ', '')))].join(', ');
        const status = report.customerName.toLowerCase().includes('cash') ? 'Paid' : 'Due';
        return `
            ${report.items.map(item => {
                if (item.productType === 'roofing') {
                    totalRoofingKg += item.weight || 0;
                } else if (item.productType === 'pipes') {
                    totalPipesKg += item.weight || 0;
                } else if (item.productType === 'polycarbonate' && item.rate > 0) {
                    // Calculate sq.ft from amount and rate
                    totalPolycarbonateSqFt += (item.amount / item.rate);
                } else if (item.productType === 'screws' && item.rate > 0) {
                    // Calculate pcs from amount and rate
                    totalScrewsPcs += (item.amount / item.rate);
                }
            }).join('')}
            <tr>
                <td>${index + 1}</td>
                <td>${report.customerName}</td>
                <td>${productTypes}</td>
                <td class="text-right">‚Çπ${entryTotal.toFixed(2)}</td>
                <td class="text-center">${status}</td>
            </tr>
        `;
    }).join('');

    const exitsRowsHtml = todaysExits.map((exit, index) => {
        totalDayExpenditure += exit.amount;
        return `
            <tr>
                <td>${index + 1}</td>
                <td colspan="2">${exit.description}</td>
                <td class="text-right">- ‚Çπ${exit.amount.toFixed(2)}</td>
                <td class="text-center">Expense</td>
            </tr>
        `;
    }).join('');

    const netTotal = totalDaySales - totalDayExpenditure;

    const html = `
        <!doctype html>
        <html><head><meta charset="utf-8"><title>Daily Report - ${new Date().toLocaleDateString()}</title>
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; color: #1a202c; background-color: #f7fafc; }
                .container { max-width: 800px; margin: auto; background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                .report-header { text-align: center; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; }
                .report-title { font-size: 22px; font-weight: 700; color: #2d3748; }
                .report-date { font-size: 14px; color: #718096; margin-top: 4px; }
                h3 { font-size: 16px; color: #2d3748; border-bottom: 1px solid #cbd5e0; padding-bottom: 5px; margin-top: 15px; margin-bottom: 10px; }
                table { width: 100%; border-collapse: collapse; font-size: 12px; }
                th, td { border: 1px solid #e2e8f0; padding: 6px 8px; text-align: left; }
                thead th { background-color: #edf2f7; font-weight: 600; color: #4a5568; }
                tbody tr:nth-child(even) { background-color: #f7fafc; }
                tfoot td { font-weight: 700; }
                .text-right { text-align: right; }
                .text-center { text-align: center; }
                .summary-table tfoot td { font-size: 14px; }
                .summary-table .net-total { background-color: #c6f6d5; color: #22543d; }
                .product-summary-table td { padding: 6px 8px; }
                @media print {
                    body { background-color: white; margin: 10mm; }
                    .container { box-shadow: none; border: none; padding: 0; }
                }
            </style>
        </head><body>
            <div class="container">
                <div class="report-header">
                    <div class="report-title">Daily Sales & Expenditure Report</div>
                    <div class="report-date">${targetDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</div>
                </div>

                <h3>Sales Entries</h3>
                <table>
                    <thead><tr><th>Sl.No</th><th>Name</th><th>Products</th><th class="text-right">Total Amount</th><th class="text-center">Status</th></tr></thead>
                    <tbody>${tableRowsHtml || '<tr><td colspan="5" style="text-align:center; padding: 20px; color: #718096;">No sales entries for today.</td></tr>'}</tbody>
                </table>

                <h3>Expenditure Entries</h3>
                <table>
                    <thead><tr><th>Sl.No</th><th colspan="2">Description</th><th class="text-right">Amount</th><th class="text-center">Type</th></tr></thead>
                    <tbody>${exitsRowsHtml || '<tr><td colspan="5" style="text-align:center; padding: 20px; color: #718096;">No expenditure entries for today.</td></tr>'}</tbody>
                </table>

                <h3>Product-wise Sales Summary</h3>
                <table class="product-summary-table">
                    <tbody>
                        <tr><td style="width:70%;">Roofing Sheets Sold</td><td class="text-right font-bold">${totalRoofingKg.toFixed(2)} kg</td></tr>
                        <tr><td>MS Pipes Sold</td><td class="text-right font-bold">${totalPipesKg.toFixed(2)} kg</td></tr>
                        <tr><td>Polycarbonate Sheets Sold</td><td class="text-right font-bold">${totalPolycarbonateSqFt.toFixed(2)} sq.ft</td></tr>
                        <tr><td>Screws Sold</td><td class="text-right font-bold">${totalScrewsPcs.toFixed(0)} pcs</td></tr>
                    </tbody>
                </table>

                <h3>Financial Summary</h3>
                <table class="summary-table">
                    <tfoot>
                        <tr><td style="width:70%" class="text-right">Total Sales</td><td class="text-right">‚Çπ${totalDaySales.toFixed(2)}</td></tr>
                        <tr><td class="text-right">Total Expenditure</td><td class="text-right">- ‚Çπ${totalDayExpenditure.toFixed(2)}</td></tr>
                        <tr class="net-total"><td class="text-right">Net Collection</td><td class="text-right">‚Çπ${netTotal.toFixed(2)}</td></tr>
                    </tfoot>
                </table>
            </div>
        </body>
        </html>
    `;

    const win = window.open('', '_blank');
    if (!win) return alert('Please allow popups to print the daily summary.');
    win.document.open();
    win.document.write(html);
    win.document.close();
    win.focus();
    setTimeout(() => { try { win.print(); } catch (e) { console.error(e); } }, 500);
}

function isSameDay(date1, date2) {
    if (!date1 || !date2) return false;
    return date1.getFullYear() === date2.getFullYear() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getDate() === date2.getDate();
}

/* Improved Enter key handling: now in its own function for clarity */
function handleEnterAsTab() {
    const forms = document.querySelectorAll('#quotationForm, #dailyReportForm, #dailyExitForm');
    forms.forEach(form => {
        form.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && event.target.tagName !== 'BUTTON') {
                // Find all focusable elements within the form that are currently visible
                const focusable = Array.from(form.querySelectorAll('input, select, button'))
                                       .filter(el => !el.disabled && el.offsetParent !== null);
                
                const currentIndex = focusable.indexOf(document.activeElement);

                // Special case: when pressing Enter on the daily report rate input,
                // focus the dedicated Save button (it sits outside the form).
                if (event.target && (event.target.id === 'reportItemRate' || event.target.matches('[name="reportItemRate"]'))) {
                    event.preventDefault();
                    const saveButton = document.getElementById('saveDailyReportBtn') || document.querySelector('button[onclick*="saveDailyReport"]');
                    if (saveButton) {
                        saveButton.focus();
                    }
                    return;
                }

                if (currentIndex > -1 && currentIndex < focusable.length - 1) {
                    event.preventDefault(); // Prevent default 'Enter' action (like form submission)
                    const nextElement = focusable[currentIndex + 1];
                    nextElement.focus();

                    // If the next element is a text input, select its content for easy replacement
                    if (nextElement.select) {
                        nextElement.select();
                    }
                }
            }

            // Shortcut for adding an item in the daily report form
            if (form.id === 'dailyReportForm' && event.key === '+') {
                event.preventDefault(); // Prevent typing '+' in an input field
                addDailyReportItem();
            }
        });
    });
}

// ===== Added: daily report tab switcher and init =====
function showDailyReportTab(tab) {
    const entryContent = document.getElementById('entryContent');
    const expenditureContent = document.getElementById('expenditureContent');
    const entryTabBtn = document.getElementById('entryTabBtn');
    const expenditureTabBtn = document.getElementById('expenditureTabBtn');

    if (!entryContent || !expenditureContent || !entryTabBtn || !expenditureTabBtn) return;

    if (tab === 'entry') {
        entryContent.classList.remove('hidden');
        expenditureContent.classList.add('hidden');
        entryTabBtn.classList.add('bg-white', 'shadow');
        expenditureTabBtn.classList.remove('bg-white', 'shadow');
    } else {
        entryContent.classList.add('hidden');
        expenditureContent.classList.remove('hidden');
        expenditureTabBtn.classList.add('bg-white', 'shadow');
        entryTabBtn.classList.remove('bg-white', 'shadow');
        // render today's exits whenever user opens expenditure tab
        renderDailyExitsPage();
    }
}
</script>
</body>
</html>